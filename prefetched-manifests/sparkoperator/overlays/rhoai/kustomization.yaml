# Red Hat OpenShift AI Overlay for Spark Operator
# All resources deployed in redhat-ods-applications namespace
#
# Usage:
#   oc apply -k config/overlays/rhoai/ --server-side=true

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# 1. Change namespace for ALL resources
namespace: redhat-ods-applications

# 2. Import base configuration
resources:
  - ../../default   # Inherits everything from config/default/

# 3. Delete the Namespace resource (RHOAI operator manages it)
patches:
  - path: delete-namespace.yaml

# 4. Add RHOAI-specific labels
labels:
  - pairs:
      app.kubernetes.io/part-of: rhoai
    includeSelectors: false

# Image substitution is handled by RHOAI operator's ApplyParams function
# which replaces $(SPARK_OPERATOR_CONTROLLER_IMAGE) and $(SPARK_OPERATOR_WEBHOOK_IMAGE)
# with values from RELATED_IMAGE_SPARK_OPERATOR_IMAGE environment variable.
# For standalone kustomize usage, use: --set-image to override images.
# TODO: Update image refs after Konflux onboarding

# 5. Replace images with RHOAI-specific ones
configMapGenerator:
  - name: spark-operator-params
    behavior: replace     # ◄── Overwrite the default ConfigMap
    envs:
      - params.env      # ◄── Use RHOAI-specific params

# 6. Inject images into deployments
# ApplyParams updates params.env with RELATED_IMAGE_SPARK_OPERATOR_IMAGE,
# and these replacements inject those values into the deployment YAMLs
replacements:
  - source:
      kind: ConfigMap
      name: spark-operator-params
      fieldPath: data.SPARK_OPERATOR_CONTROLLER_IMAGE
    targets:
      - select:
          kind: Deployment
          name: spark-operator-controller
        fieldPaths:
          - spec.template.spec.containers.[name=controller].image
  - source:
      kind: ConfigMap
      name: spark-operator-params
      fieldPath: data.SPARK_OPERATOR_WEBHOOK_IMAGE
    targets:
      - select:
          kind: Deployment
          name: spark-operator-webhook
        fieldPaths:
          - spec.template.spec.containers.[name=webhook].image