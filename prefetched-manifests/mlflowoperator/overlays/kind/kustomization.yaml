apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Development overlay - uses base without operator image replacement
# This allows 'kustomize edit set image' to work for local development and CI
# Override namespace to use parameterized value instead of hardcoded 'opendatahub'
namespace: $NAMESPACE

resources:
  - ../../base

patches:
  - path: manager-rolebinding-patch.yaml
    target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: mlflow-operator-manager-rolebinding
  - path: metrics-auth-rolebinding-patch.yaml
    target:
      group: rbac.authorization.k8s.io
      version: v1
      kind: ClusterRoleBinding
      name: mlflow-operator-metrics-auth-rolebinding
  - path: manager-patch.yaml
    target:
      group: apps
      version: v1
      kind: Deployment
      name: mlflow-operator-controller-manager

# Add operator image replacement for dev/kind overlay
replacements:
# Replace operator image using value from params.env
- source:
    kind: ConfigMap
    name: operator-params
    fieldPath: data.MLFLOW_OPERATOR_IMAGE
  targets:
  - select:
      kind: Deployment
      name: mlflow-operator-controller-manager
    fieldPaths:
    - spec.template.spec.containers.[name=manager].image


# Override operator params with kind-specific values
configMapGenerator:
- name: operator-params
  envs:
  - params.env
  behavior: replace

# Generate TLS secret using pre-generated certificate files
secretGenerator:
- name: mlflow-tls
  type: kubernetes.io/tls
  files:
  - tls.crt
  - tls.key
  options:
    disableNameSuffixHash: true
